name: Render Blog Analysis (ZZCOLLAB)

on:
  push:
    branches: [main, master]
    paths:
      - 'analysis/**'
      - 'R/**'
      - 'tests/**'
      - 'renv.lock'
      - 'Dockerfile'
      - '.github/workflows/r-package.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'analysis/**'
      - 'R/**'
      - 'tests/**'
      - 'renv.lock'
      - 'Dockerfile'

jobs:
  render-blog:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Docker Buildx for efficient caching
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 3: Build Docker image from Dockerfile
      # Creates reproducible environment with R 4.5.1, system
      # dependencies, and required C libraries
      - name: Build Docker image
        run: |
          echo "ðŸ³ Building computational environment..."
          docker build -t compendium-env .
          echo "âœ… Docker image built successfully"

      # Step 4: Run unit tests (conditional - only if tests exist)
      # Packages pre-installed in Docker image from renv.lock
      # Skips gracefully if tests/testthat directory doesn't exist or is empty
      - name: Run unit tests
        run: |
          echo "ðŸ§ª Checking for unit tests..."
          # Check if tests/testthat directory exists and has *.R files
          if [ -d "tests/testthat" ] && ls tests/testthat/*.R > /dev/null 2>&1; then
            echo "âœ… Tests found - running testthat..."
            docker run --rm -v ${{ github.workspace }}:/home/analyst/project \
              -w /home/analyst/project \
              --user root \
              compendium-env bash -c '
              # Fix permissions for mounted volume (GitHub Actions)
              chown -R analyst:analyst /home/analyst/project
              mkdir -p /home/analyst/project/renv
              chown -R analyst:analyst /home/analyst/project/renv
              # Switch to analyst user for operations
              su - analyst -c "cd /home/analyst/project && Rscript -e '"'"'testthat::test_dir(\"tests/testthat\", reporter=\"summary\")'"'"'" 2>&1
            '
            echo "âœ… All unit tests passed"
          else
            echo "â­ï¸  No unit tests found - skipping (tests/testthat/*.R not present)"
          fi

      # Step 5: Run analysis pipeline
      # Execute data processing, model fitting, figure generation
      - name: Run analysis pipeline
        run: |
          echo "ðŸ“Š Executing analysis scripts..."
          docker run --rm -v ${{ github.workspace }}:/home/analyst/project \
            -w /home/analyst/project \
            --user root \
            compendium-env bash -c '
            # Fix permissions for mounted volume (GitHub Actions)
            chown -R analyst:analyst /home/analyst/project
            mkdir -p /home/analyst/project/renv
            chown -R analyst:analyst /home/analyst/project/renv
            # Switch to analyst user for operations
            su - analyst -c "cd /home/analyst/project && for s in analysis/scripts/*.R; do if [ -f \"\$s\" ]; then echo \"  â†’ Running \$(basename \$s)...\" && Rscript \"\$s\" || exit 1; fi; done; echo \"Scripts completed\"" 2>&1
          '
          echo "âœ… Analysis pipeline completed"

      # Step 6: Render Quarto report (MAIN DELIVERABLE)
      # Primary output: HTML report with analysis results
      - name: Render Quarto report
        run: |
          echo "ðŸ“„ Rendering Quarto report..."
          docker run --rm -v ${{ github.workspace }}:/home/analyst/project \
            -w /home/analyst/project \
            --user root \
            compendium-env bash -c '
            # Fix permissions for mounted volume (GitHub Actions)
            chown -R analyst:analyst /home/analyst/project
            mkdir -p /home/analyst/project/renv
            chown -R analyst:analyst /home/analyst/project/renv
            # Switch to analyst user for operations
            su - analyst -c "cd /home/analyst/project && quarto render analysis/paper/index.qmd --to html" 2>&1
          '
          echo "âœ… Report rendered to HTML"

      # Step 7: Verify rendered output exists
      # Sanity check that rendering produced files
      - name: Verify rendered output
        run: |
          echo "ðŸ”Ž Verifying rendered output..."
          docker run --rm -v ${{ github.workspace }}:/home/analyst/project \
            -w /home/analyst/project \
            --user root \
            compendium-env bash -c '
            # Fix permissions for mounted volume (GitHub Actions)
            chown -R analyst:analyst /home/analyst/project
            mkdir -p /home/analyst/project/renv
            chown -R analyst:analyst /home/analyst/project/renv
            # Switch to analyst user for operations
            su - analyst -c "cd /home/analyst/project && test -f analysis/paper/index.html && test -s analysis/paper/index.html" 2>&1
          ' && \
          echo "âœ… Rendered HTML report exists and not empty"

      # Step 8: Upload rendered report as artifact
      # Makes report accessible from GitHub UI
      - name: Upload rendered report
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: rendered-report
          path: analysis/paper/index.html
          retention-days: 30

      # Step 9: Create workflow success summary
      # Displays results in GitHub UI
      - name: Create success summary
        if: success()
        run: |
          echo "## âœ… Blog Analysis Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Analysis pipeline completed successfully." >> \
            $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pipeline Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker image built (packages pre-installed)" >> \
            $GITHUB_STEP_SUMMARY
          echo "- âœ… Unit tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Analysis pipeline executed" >> \
            $GITHUB_STEP_SUMMARY
          echo "- âœ… Quarto report rendered to HTML" >> \
            $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reproducibility:**" >> $GITHUB_STEP_SUMMARY
          echo "- Docker image: rocker/r-ver:4.5.1 + packages" >> \
            $GITHUB_STEP_SUMMARY
          echo "- Packages: Pre-installed from renv.lock" >> \
            $GITHUB_STEP_SUMMARY
          echo "- Report: Available in Actions tab" >> \
            $GITHUB_STEP_SUMMARY

      # Step 10: Create workflow failure summary
      # Help debug when something goes wrong
      - name: Create failure summary
        if: failure()
        run: |
          echo "## âŒ Blog Analysis Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check logs and follow debugging steps:" >> \
            $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Tests failed: Fix tests/testthat/" >> \
            $GITHUB_STEP_SUMMARY
          echo "2. Validation failed: Check DESCRIPTION" >> \
            $GITHUB_STEP_SUMMARY
          echo "3. Analysis failed: Review analysis/scripts/" >> \
            $GITHUB_STEP_SUMMARY
          echo "4. Rendering failed: Check analysis/paper/" >> \
            $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Local debugging:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "make docker-run  # Start interactive session" >> \
            $GITHUB_STEP_SUMMARY
          echo "Rscript tests/testthat/test-utils.R" >> \
            $GITHUB_STEP_SUMMARY
          echo "Rscript analysis/scripts/01_*.R" >> \
            $GITHUB_STEP_SUMMARY
          echo "quarto::quarto_render(...)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
